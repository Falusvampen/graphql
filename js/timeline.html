<!DOCTYPE html>
<html>
  <head>
    <style>
      .tooltip {
        position: absolute;
        text-align: center;
        padding: 10px;
        font-size: 12px;
        background: #f8f8f8;
        border: 1px solid #ccc;
        border-radius: 4px;
        pointer-events: none;
        box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.3s;
        /* Updated positioning */
        transform: translate(-50%, -100%);
      }

      #timeline {
        display: block;
        margin: 0 auto;
        background-color: #fff;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
      }
      .dot {
        stroke: #fff;
        stroke-width: 2px;
      }
    </style>
  </head>
  <body>
    <h1>User Timeline Chart</h1>
    <svg id="timeline"></svg>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      const data = {
        data: {
          user: [
            {
              timeline: [
                {
                  amount: 34375,
                  createdAt: "2023-04-04T10:56:14.168751+00:00",
                  path: "/gritlab/school-curriculum/lem-in",
                },
                {
                  amount: 5000,
                  createdAt: "2022-09-07T16:50:46.447947+00:00",
                  path: "/gritlab/school-curriculum/go-reloaded",
                },
                {
                  amount: 100,
                  createdAt: "2022-09-22T10:01:58.595203+00:00",
                  path: "/gritlab/school-curriculum/checkpoint/displayalrevm",
                },
                {
                  amount: 200,
                  createdAt: "2022-09-22T10:03:33.668528+00:00",
                  path: "/gritlab/school-curriculum/checkpoint/countdown",
                },
                {
                  amount: 6125,
                  createdAt: "2022-09-29T16:26:55.142587+00:00",
                  path: "/gritlab/school-curriculum/ascii-art",
                },
                {
                  amount: 6125,
                  createdAt: "2022-10-03T10:44:43.388201+00:00",
                  path: "/gritlab/school-curriculum/output",
                },
                {
                  amount: 6125,
                  createdAt: "2022-10-03T11:24:23.928278+00:00",
                  path: "/gritlab/school-curriculum/fs",
                },
                {
                  amount: 70000,
                  createdAt: "2023-01-30T08:32:17.268497+00:00",
                  path: "/gritlab/school-curriculum/piscine-js",
                },
                {
                  amount: 9200,
                  createdAt: "2022-11-16T16:10:52.168946+00:00",
                  path: "/gritlab/school-curriculum/ascii-art-web",
                },
                {
                  amount: 6125,
                  createdAt: "2022-10-17T17:39:25.724325+00:00",
                  path: "/gritlab/school-curriculum/color",
                },
                {
                  amount: 9200,
                  createdAt: "2022-11-16T16:53:36.429254+00:00",
                  path: "/gritlab/school-curriculum/stylize",
                },
                {
                  amount: 9200,
                  createdAt: "2022-11-25T13:27:32.573082+00:00",
                  path: "/gritlab/school-curriculum/dockerize",
                },
                {
                  amount: 24500,
                  createdAt: "2022-12-09T12:38:34.268016+00:00",
                  path: "/gritlab/school-curriculum/groupie-tracker",
                },
                {
                  amount: 12250,
                  createdAt: "2022-12-16T15:15:51.631782+00:00",
                  path: "/gritlab/school-curriculum/visualizations",
                },
                {
                  amount: 12250,
                  createdAt: "2022-12-20T19:41:58.392034+00:00",
                  path: "/gritlab/school-curriculum/net-cat",
                },
                {
                  amount: 100,
                  createdAt: "2022-09-08T10:03:41.537351+00:00",
                  path: "/gritlab/school-curriculum/checkpoint/printdigits",
                },
                {
                  amount: 200,
                  createdAt: "2022-09-08T10:09:39.286782+00:00",
                  path: "/gritlab/school-curriculum/checkpoint/max",
                },
                {
                  amount: 300,
                  createdAt: "2022-09-08T11:13:01.231732+00:00",
                  path: "/gritlab/school-curriculum/checkpoint/rot13",
                },
                {
                  amount: 400,
                  createdAt: "2022-09-08T11:27:23.075198+00:00",
                  path: "/gritlab/school-curriculum/checkpoint/alphamirror",
                },
                {
                  amount: 300,
                  createdAt: "2022-09-22T10:09:40.540012+00:00",
                  path: "/gritlab/school-curriculum/checkpoint/rot13",
                },
                {
                  amount: 400,
                  createdAt: "2022-09-22T10:11:22.135932+00:00",
                  path: "/gritlab/school-curriculum/checkpoint/compare",
                },
                {
                  amount: 500,
                  createdAt: "2022-09-22T11:58:16.813304+00:00",
                  path: "/gritlab/school-curriculum/checkpoint/reversebits",
                },
                {
                  amount: 600,
                  createdAt: "2022-09-22T12:13:35.874935+00:00",
                  path: "/gritlab/school-curriculum/checkpoint/printhex",
                },
              ],
            },
          ],
        },
      };

      function createTimeline(thicc, smoll, data) {
        data.data.user[0].timeline.sort(
          (a, b) => new Date(a.createdAt) - new Date(b.createdAt)
        );

        const startDate = new Date(data.data.user[0].timeline[0].createdAt);
        const endDate = new Date(
          data.data.user[0].timeline[
            data.data.user[0].timeline.length - 1
          ].createdAt
        );

        startDate.setDate(1);
        startDate.setHours(0, 0, 0, 0);
        endDate.setDate(1);
        endDate.setMonth(endDate.getMonth() + 1);
        endDate.setHours(0, 0, 0, 0);

        const margin = { top: 10, right: 30, bottom: 30, left: 60 },
          width = thicc - margin.left - margin.right,
          height = smoll - margin.top - margin.bottom;

        const svg = d3
          .select("#timeline")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleTime().domain([startDate, endDate]).range([0, width]);

        svg
          .append("g")
          .attr("transform", `translate(0, ${height})`)
          .call(
            d3
              .axisBottom(x)
              .ticks(d3.timeMonth.every(1))
              .tickFormat(d3.timeFormat("%B"))
          );

        const tooltip = d3
          .select("body")
          .append("div")
          .attr("class", "tooltip")
          .style("opacity", 0)
          .style("left", "50%") // Set initial left position
          .style("top", "0"); // Set initial top position

        const mergeOverlappingDots = (data) => {
          let mergedData = [];
          let tempData = [];

          data.forEach((item, i) => {
            if (i === 0) {
              tempData.push(item);
            } else if (
              Math.abs(
                x(new Date(data[i - 1].createdAt)) - x(new Date(item.createdAt))
              ) < 6
            ) {
              tempData.push(item);
            } else {
              mergedData.push(tempData);
              tempData = [item];
            }
          });

          mergedData.push(tempData);
          return mergedData;
        };

        const mergedData = mergeOverlappingDots(data.data.user[0].timeline);

        const colorScale = d3
          .scaleLinear()
          .domain([0, d3.max(data.data.user[0].timeline, (d) => d.amount)])
          .range(["#3366cc", "#cc3366"]);

        svg
          .selectAll(".dot")
          .data(mergedData)
          .enter()
          .append("circle")
          .attr("class", "dot")
          .attr("r", (d) => 5)
          .attr("cx", (d) => x(new Date(d[0].createdAt)))
          .attr("cy", height)
          .attr("fill", (d) => colorScale(d[0].amount)) // Fill dots with color based on amount
          .on("mouseover", function (event, d) {
            tooltip.transition().duration(200).style("opacity", 0.9);

            let tooltipHtml = "";

            // Group projects by date
            let dateGroupedProjects = d.reduce((group, project) => {
              let date = d3.timeFormat("%B %d, %Y")(
                new Date(project.createdAt)
              );
              if (!group[date]) group[date] = [];
              group[date].push(project);
              return group;
            }, {});

            // Generate tooltip HTML
            for (let date in dateGroupedProjects) {
              tooltipHtml += `${date}<br/>`;
              tooltipHtml += dateGroupedProjects[date]
                .map(
                  (project) =>
                    `${project.path.split("/").pop()}<br/>${project.amount} XP`
                )
                .join("<br/><br/>");
              tooltipHtml += "<br/><br/>";
            }

            tooltip
              .html(tooltipHtml)
              .style("left", event.pageX + "px")
              .style("top", event.pageY - 28 + "px");
          })

          .on("mouseout", function (d) {
            tooltip.transition().duration(500).style("opacity", 0);
          });
      }
      createTimeline(800, 400, data);
    </script>
  </body>
</html>
